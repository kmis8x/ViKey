name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test-core:
    name: Test Core Engine
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ci-core-cargo-${{ hashFiles('core/Cargo.lock') }}
        restore-keys: ci-core-cargo-

    - name: Run tests
      working-directory: core
      run: cargo test --release

    - name: Check formatting
      working-directory: core
      run: cargo fmt --check

    - name: Run clippy
      working-directory: core
      run: cargo clippy --release -- -D warnings

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: test-core

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
          app-linux/target
        key: ci-linux-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ci-linux-cargo-

    - name: Install IBus development libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y libibus-1.0-dev pkg-config

    - name: Build core
      working-directory: core
      run: cargo build --release --target x86_64-unknown-linux-gnu

    - name: Copy library
      run: |
        mkdir -p app-linux/lib
        cp core/target/x86_64-unknown-linux-gnu/release/libvikey_core.a app-linux/lib/

    - name: Build IBus engine
      working-directory: app-linux
      run: cargo build --release

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: test-core

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ci-macos-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ci-macos-cargo-

    - name: Build core
      working-directory: core
      run: cargo build --release --target aarch64-apple-darwin

    - name: Copy library
      run: |
        mkdir -p app-macos/ViKey/lib
        cp core/target/aarch64-apple-darwin/release/libvikey_core.a app-macos/ViKey/lib/

    - name: Build Swift app
      working-directory: app-macos
      run: |
        mkdir -p build/ViKey.app/Contents/MacOS
        mkdir -p build/ViKey.app/Contents/Resources

        swiftc \
          -O \
          -import-objc-header ViKey/Sources/ViKey-Bridging-Header.h \
          -L ViKey/lib \
          -lvikey_core \
          -framework Foundation \
          -framework AppKit \
          -framework InputMethodKit \
          -target arm64-apple-macos12.0 \
          -o build/ViKey.app/Contents/MacOS/ViKey \
          ViKey/Sources/main.swift \
          ViKey/Sources/RustBridge.swift \
          ViKey/Sources/ViKeyInputController.swift \
          ViKey/Sources/Settings.swift

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: test-core

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ci-windows-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ci-windows-cargo-

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Build core
      working-directory: core
      run: cargo build --release

    - name: Build Win32 application
      working-directory: app-native
      run: MSBuild ViKey.vcxproj /p:Configuration=Release /p:Platform=x64 /m /nologo /v:minimal
